---
title: "project2"
output: html_document
date: '2023-10-07'
---

```{r setup, include=FALSE}
#install.packages("httr")
library(httr)
#install.packages("jsonlite")
library(jsonlite)
library(shiny)
library(leaflet)
library(RColorBrewer)

```

```{r cars}
url = "https://www.fema.gov/api/open/v2/FimaNfipClaims"
res = GET(url)
flood = fromJSON(rawToChar(res$content))
head(data)
```

```{r }
# Extract the data frame from the list
data <- flood$FimaNfipClaims
# Write the data frame to a CSV
#write.csv(data, "/Users/maheze/Desktop/FimaNfipClaims.csv", row.names = FALSE)
```

```{r ui}

ui <- fluidPage(
    titlePanel("Geospatial Analysis of Flood across States"),
    
    sidebarLayout(
        sidebarPanel(
            selectInput("display", "Choose Display:",
                        choices = c("Geographical Location of Flood","Claim Payouts vs Coverage Amount", 
                                    "Cause of Damage")),
            selectInput("year", "Select Year of Loss:",
                        choices = c("All Years", sort(unique(data$yearOfLoss))), 
                        selected = "All Years"),
            selectInput("state", "Select State:",
                        choices = c("All States", sort(unique(data$state))), 
                        selected = "All States")  
        ),
        
        mainPanel(
            leafletOutput("map")
        )
    )
)


```

```{r server}

server <- function(input, output) {
    
    # Define the mapping for cause of damage
    cause_mapping <- c(
        "0" = "Other causes",
        "1" = "Tidal water overflow",
        "2" = "Stream, river, or lake overflow",
        "3" = "Alluvial fan overflow",
        "4" = "Accumulation of rainfall or snowmelt",
        "7" = "Erosion-demolition",
        "8" = "Erosion-removal",
        "9" = "Earth movement, landslide, land subsidence, sinkholes, etc.",
        "A" = "Closed basin lake",
        "B" = "Expedited claim handling process without site inspection",
        "C" = "Expedited claim handling process follow-up site inspection",
        "D" = "Expedited claim handling process by Adjusting Process Pilot Program (Remote Adjustment)"
    )
    
    output$map <- renderLeaflet({
        # Start filtering from the full dataset
        filtered_data <- data
        
        if (input$year != "All Years") {
            filtered_data <- subset(filtered_data, yearOfLoss == input$year)
        }
        if (input$state != "All States") {
            filtered_data <- subset(filtered_data, state == input$state)
        }
        
        m <- leaflet(data = filtered_data) %>%
            addTiles() %>%
            setView(lng = -98.35, lat = 39.50, zoom = 4)
        
        if(input$display == "Claim Payouts vs Coverage Amount") {
            # Assuming "amountPaidOnBuildingClaim" as claim payouts and "totalBuildingInsuranceCoverage" as coverage amount
            ratio <- filtered_data$amountPaidOnBuildingClaim / filtered_data$totalBuildingInsuranceCoverage
            pal <- colorQuantile("YlGnBu", ratio, n = 5)
            m <- addCircleMarkers(m, ~longitude, ~latitude, 
                                   color = ~pal(ratio),
                                   radius = 3, 
                                   fillOpacity = 0.5,
                                   popup = ~paste("Payout/Coverage Ratio:", round(ratio, 2)))
        } else if(input$display == "Geographical Location of Flood") {
            m <- addCircleMarkers(m, ~longitude, ~latitude, 
                                   color = "red", 
                                   radius = 3, 
                                   fillOpacity = 0.5,
                                   popup = ~paste("Longitude:", longitude, "<br>Latitude:", latitude))
  
        } else if(input$display == "Cause of Damage") {
            pal <- colorFactor("Set1", levels(filtered_data$causeOfDamage))
            m <- addCircleMarkers(m, ~longitude, ~latitude, 
                                   color = ~pal(causeOfDamage),
                                   radius = 3, 
                                   fillOpacity = 0.5,
                                   popup = ~paste("Cause:", cause_mapping[as.character(causeOfDamage)]))
        } else {
            m <- addCircleMarkers(m, ~longitude, ~latitude, 
                                   color = "red", 
                                   radius = 3, 
                                   fillOpacity = 0.5,
                                   popup = ~paste("Longitude:", longitude, "<br>Latitude:", latitude))
        }
        
        m
    })
}

shinyApp(ui = ui, server = server)


```

